name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        perl: ['5.28', '5.38', '5.40']
    name: Linux ${{ matrix.os }} / Perl ${{ matrix.perl }}
    steps:
      - uses: actions/checkout@v4

      - uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgrpc-dev libgrpc++-dev libprotobuf-c-dev pkg-config

      - name: Install Perl dependencies
        run: cpanm --notest EV

      - name: Build
        run: |
          perl Makefile.PL
          make

      - name: Install etcd
        run: |
          curl -fsSL https://github.com/etcd-io/etcd/releases/download/v3.5.26/etcd-v3.5.26-linux-amd64.tar.gz | tar xz
          sudo mv etcd-v3.5.26-linux-amd64/etcd /usr/local/bin/
          sudo mv etcd-v3.5.26-linux-amd64/etcdctl /usr/local/bin/

      - name: Start etcd
        run: |
          etcd --data-dir /tmp/etcd-data &
          for i in $(seq 1 30); do
            etcdctl endpoint health 2>/dev/null && break
            sleep 1
          done
          etcdctl endpoint health

      - name: Test
        run: make test

  test-debian:
    runs-on: ubuntu-latest
    container: debian:bookworm
    name: Debian bookworm
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y build-essential perl curl pkg-config \
            libgrpc-dev libgrpc++-dev libprotobuf-c-dev

      - name: Install cpanm and Perl dependencies
        run: |
          curl -fsSL https://cpanmin.us | perl - App::cpanminus
          cpanm --notest EV

      - name: Build
        run: |
          perl Makefile.PL
          make

      - name: Install etcd
        run: |
          curl -fsSL https://github.com/etcd-io/etcd/releases/download/v3.5.26/etcd-v3.5.26-linux-amd64.tar.gz | tar xz
          mv etcd-v3.5.26-linux-amd64/etcd /usr/local/bin/
          mv etcd-v3.5.26-linux-amd64/etcdctl /usr/local/bin/

      - name: Start etcd
        run: |
          etcd --data-dir /tmp/etcd-data &
          for i in $(seq 1 30); do
            etcdctl endpoint health 2>/dev/null && break
            sleep 1
          done
          etcdctl endpoint health

      - name: Test
        run: make test

  test-macos:
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        perl: ['5.38', '5.40']
    name: macOS / Perl ${{ matrix.perl }}
    steps:
      - uses: actions/checkout@v4

      - uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl }}

      - name: Install dependencies
        run: brew install grpc protobuf-c pkg-config etcd

      - name: Install Perl dependencies
        run: cpanm --notest EV

      - name: Build
        run: |
          perl Makefile.PL
          make

      - name: Start etcd
        run: |
          etcd --data-dir /tmp/etcd-data &
          for i in $(seq 1 30); do
            etcdctl endpoint health 2>/dev/null && break
            sleep 1
          done
          etcdctl endpoint health

      - name: Test
        run: make test

  test-freebsd:
    runs-on: ubuntu-latest
    name: FreeBSD 14.2
    steps:
      - uses: actions/checkout@v4
      - uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          usesh: true
          prepare: |
            pkg install -y grpc protobuf-c pkgconf perl5 p5-EV gmake
            pkg install -y etcd3 || pkg install -y etcd || true
          run: |
            perl Makefile.PL
            gmake
            if command -v etcd >/dev/null 2>&1; then
              etcd --data-dir /tmp/etcd-data &
              sleep 5
              etcdctl endpoint health 2>/dev/null || true
            fi
            gmake test

  test-openbsd:
    runs-on: ubuntu-latest
    name: OpenBSD
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: vmactions/openbsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg_add gmake grpc protobuf-c pkgconf
            pkg_add p5-EV || true
          run: |
            perl Makefile.PL
            gmake
            gmake test

  test-netbsd:
    runs-on: ubuntu-latest
    name: NetBSD
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: vmactions/netbsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg_add pkgin
            pkgin -y install gmake grpc protobuf-c pkgconf
            pkgin -y install p5-EV || true
          run: |
            perl Makefile.PL
            gmake
            gmake test
